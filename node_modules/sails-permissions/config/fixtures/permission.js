var grants = {
  admin: [
    { action: 'create' },
    { action: 'read' },
    { action: 'update' },
    { action: 'delete' }
  ],
  registered: [
    { action: 'create' },
    { action: 'read' }
  ],
  public: [
    { action: 'read' }
  ]
};

var modelRestrictions = {
  registered: [
    'Role',
    'Permission',
    'User',
    'Passport'
  ],
  public: [
    'Role',
    'Permission',
    'User',
    'Model',
    'Passport'
  ]
};

// TODO let users override this in the actual model definition

/**
 * Create default Role permissions
 */
exports.create = function (roles, models, admin) {
  return Promise.all([
    grantAdminPermissions(roles, models, admin),
    grantRegisteredPermissions(roles, models, admin)
  ])
  .then(function (permissions) {
    //sails.log('created', permissions.length, 'permissions');
    return permissions;
  });
};

function grantAdminPermissions (roles, models, admin) {
  var adminRole = _.find(roles, { name: 'admin' });
  var permissions = _.flatten(_.map(models, function (modelEntity) {
    var model = sails.models[modelEntity.identity];

    return _.map(grants.admin, function (permission) {
      var newPermission = {
        model: modelEntity.id,
        action: permission.action,
        role: adminRole.id,
        createdBy: admin.id
      };
      return Permission.findOrCreate(newPermission, newPermission);
    });
  }));

  return Promise.all(permissions);
}

function grantRegisteredPermissions (roles, models, admin) {
  var registeredRole = _.find(roles, { name: 'registered' });
  var permissions = [
    {
      model: _.find(models, { name: 'Permission' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id
    },
    {
      model: _.find(models, { name: 'Model' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id
    },
    {
      model: _.find(models, { name: 'User' }).id,
      action: 'update',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },
    //Poster permission granted to registered user
    {
      model: _.find(models, { name: 'Poster' }).id,
      action: 'create',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'Poster' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'Poster' }).id,
      action: 'update',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },    
    {
      model: _.find(models, { name: 'Poster' }).id,
      action: 'delete',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },
    //Proposal permission granted to registered user
    {
      model: _.find(models, { name: 'Proposal' }).id,
      action: 'create',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'Proposal' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner' 
    },
    {
      model: _.find(models, { name: 'Proposal' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'authowner' 
    },
    {
      model: _.find(models, { name: 'Proposal' }).id,
      action: 'update',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },    
    {
      model: _.find(models, { name: 'Proposal' }).id,
      action: 'delete',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },
    //Comment permission granted to registered user
    {
      model: _.find(models, { name: 'Comment' }).id,
      action: 'create',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'Comment' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'Comment' }).id,
      action: 'update',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },    
    {
      model: _.find(models, { name: 'Comment' }).id,
      action: 'delete',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },
    //PrivateTalk permission granted to registered user
    {
      model: _.find(models, { name: 'PrivateTalk' }).id,
      action: 'create',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role'
    },
    {
      model: _.find(models, { name: 'PrivateTalk' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner' 
    },
    {
      model: _.find(models, { name: 'PrivateTalk' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'authowner'
    },
    {
      model: _.find(models, { name: 'PrivateTalk' }).id,
      action: 'update',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },    
    {
      model: _.find(models, { name: 'PrivateTalk' }).id,
      action: 'delete',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'owner'
    },
    //Node permission granted to registered user
    {
      model: _.find(models, { name: 'Node' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role' 
    },
    //Tip permission granted to registered user
    {
      model: _.find(models, { name: 'Tip' }).id,
      action: 'read',
      role: registeredRole.id,
      createdBy: admin.id,
      relation: 'role' 
    },
  ];

  return Promise.all(
    _.map(permissions, function (permission) {
      return Permission.findOrCreate(permission, permission);
    })
  );
}
